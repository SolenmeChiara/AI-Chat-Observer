# ğŸ—ï¸ é¡¹ç›®æ¶æ„æ–‡æ¡£ (Project Architecture)

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† **AI ç¾¤èŠè§‚å¯Ÿä¼š (V5.5)** çš„ä»£ç ç»“æ„ã€æ•°æ®æµå‘åŠè®¾è®¡ç†å¿µã€‚æ—¨åœ¨å¸®åŠ©å¼€å‘è€…å¿«é€Ÿç†è§£ç³»ç»Ÿï¼Œå¹¶ä¸ºåç»­å¼•å…¥ **å‘é‡æ•°æ®åº“ (Vector DB)**ã€**é•¿æœŸè®°å¿† (Long-term Memory)** æˆ– **åç«¯æœåŠ¡** æä¾›æŒ‡å¯¼ã€‚

**V5.5 æ–°å¢åŠŸèƒ½ï¼š**
- ç§è®¯ç³»ç»Ÿ (PM)ï¼šAI å’Œäººç±»å‡å¯å‘é€ç§è®¯ï¼Œä»…ç›®æ ‡æˆå‘˜å’Œäººç±»ç”¨æˆ·å¯è§
- åŒé‡è¾“å‡ºï¼šAI å¯åŒæ—¶å‘å…¬å¼€æ¶ˆæ¯ + ç§è®¯ï¼ˆ`{{RESPONSE:}}` + `{{RES_PM_Name:}}`ï¼‰
- å•å‘å¯è§æ€§å±è”½ï¼šä¼šè¯çº§é…ç½®æŸ agent çœ‹ä¸åˆ°ç‰¹å®šæˆå‘˜çš„æ¶ˆæ¯
- äººç±»ä¼ªè£…ï¼šå°† agent æ ‡è®°ä¸º"äººç±»"ä»¥æ¬ºéª—å…¶ä»– agent
- Per-agent PM å¼€å…³ï¼šç¾¤ç»„æ€»å¼€å…³ + æ¯ä¸ª agent å•ç‹¬å¯ç”¨/ç¦ç”¨ç§è®¯
- PM æ¶ˆæ¯ç´«è‰²æ–‡å­—æ¸²æŸ“ + å¾½ç« æ ‡è®°
- Anthropic thinking mode é˜²ä¸­æ¯’ï¼šå†å²æ¶ˆæ¯ç¼ºå°‘ thinking block ä¸å†æ°¸ä¹…ç¦ç”¨æ€ç»´é“¾

**V5.4 åŠŸèƒ½ï¼š**
- è¾©è®º/å‘è¨€é¡ºåºæ¨¡å¼ï¼šä¼šè¯çº§æ­£åæ–¹åˆ†ç»„ + äº¤æ›¿å‘è¨€ turn sequence
- @mention æ¦‚ç‡è¡°å‡ï¼šé˜²æ­¢éšæœºæ¨¡å¼ä¸‹ä¸¤ä¸ª AI äº’ @ å½¢æˆäºŒäººè½¬
- è¾©è®ºæ¨¡å¼ä¸‹ AI çš„ @mention ä¸åŠ«æŒ turn sequence
- è¾©è®ºè§’è‰²è‡ªåŠ¨æ³¨å…¥ system promptï¼ˆå‘ŠçŸ¥ AI è‡ªå·±æ˜¯æ­£æ–¹/åæ–¹ç¬¬å‡ å·ï¼‰
- å•æ¡æ¶ˆæ¯åˆ é™¤æŒ‰é’®
- TTS è®¾ç½®é¢æ¿å¯æŠ˜å 

**V5.3 åŠŸèƒ½ï¼š**
- å¨±ä¹å·¥å…·ï¼šéª°å­ `{{ROLL: XdY+Z}}` å’Œå¡”ç½—ç‰Œ `{{TAROT: N}}`
- ç¾¤ç»„çº§å¨±ä¹åŠŸèƒ½å¼€å…³
- è‡ªåŠ¨æç¤ºè¯æ³¨å…¥ (AI è‡ªåŠ¨è·çŸ¥å¯ç”¨çš„å¨±ä¹å·¥å…·)

**V5.2 åŠŸèƒ½ï¼š**
- å¤šæœåŠ¡å•† TTS è¯­éŸ³åˆæˆ (Browser/OpenAI/ElevenLabs/MiniMax/Fish Audio/Azure)
- è‡ªå®šä¹‰éŸ³è‰²ç®¡ç†ä¸ Agent éŸ³è‰²åˆ†é…
- å…¨å±€å±•å¼€/æŠ˜å æ€ç»´é“¾æŒ‰é’®
- è¶…æ—¶æ—¶é—´æ»‘å—æ‰©å±•è‡³ 5 åˆ†é’Ÿ

---

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

æœ¬é¡¹ç›®é‡‡ç”¨ **Local-First (æœ¬åœ°ä¼˜å…ˆ)** ä¸ **Serverless (æ— åç«¯)** æ¶æ„ï¼š

*   **çŠ¶æ€ç®¡ç†**ï¼šReact `useState` + `useRef` æ§åˆ¶å®æ—¶äº¤äº’ä¸æµå¼å“åº”ã€‚
*   **æŒä¹…åŒ–**ï¼šä½¿ç”¨ **IndexedDB (Dexie.js)** ä½œä¸ºæœ¬åœ°æ•°æ®åº“ï¼Œæ‰€æœ‰æ•°æ®ï¼ˆAPI Keyã€é…ç½®ã€èŠå¤©è®°å½•ï¼‰å‡å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ç«¯ã€‚
*   **é€»è¾‘åˆ†å±‚**ï¼šUI ç»„ä»¶åªè´Ÿè´£æ¸²æŸ“ï¼Œå¤æ‚é€»è¾‘å°è£…åœ¨ `services/` ç›®å½•ä¸­ã€‚
*   **å¤šæ€é€‚é…**ï¼šé€šè¿‡é€‚é…å™¨æ¨¡å¼ç»Ÿä¸€å¤„ç† Google Geminiã€OpenAIã€Anthropic ç­‰ä¸åŒ API çš„è¾“å…¥è¾“å‡ºå·®å¼‚ã€‚

---

## 2. ç›®å½•ç»“æ„è¯´æ˜

```text
src/
â”œâ”€â”€ components/          # UI ç»„ä»¶å±‚
â”‚   â”œâ”€â”€ ChatBubble.tsx   # æ ¸å¿ƒç»„ä»¶ï¼šè´Ÿè´£æ¸²æŸ“æ¶ˆæ¯ã€Markdownã€æ€ç»´é“¾ã€é™„ä»¶
â”‚   â”œâ”€â”€ Sidebar.tsx      # å·¦ä¾§æ ï¼šå…¨å±€é…ç½®ã€è§’è‰²ç¼–è¾‘ã€ä¼šè¯åˆ‡æ¢
â”‚   â””â”€â”€ RightSidebar.tsx # å³ä¾§æ ï¼šç¾¤æˆå‘˜ç®¡ç†ã€å¿«æ·æ“ä½œ
â”‚
â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®å±‚ (Service Layer)
â”‚   â”œâ”€â”€ db.ts            # IndexedDB æ•°æ®åº“ç®¡ç† (CRUD)
â”‚   â”œâ”€â”€ geminiService.ts # Gemini API é€‚é…å™¨ (å« Prompt æ³¨å…¥)
â”‚   â”œâ”€â”€ openaiService.ts # OpenAI å…¼å®¹æ¥å£é€‚é…å™¨ (å« Prompt æ³¨å…¥)
â”‚   â”œâ”€â”€ anthropicService.ts # Claude åŸç”Ÿ API é€‚é…å™¨ (å« Prompt æ³¨å…¥)
â”‚   â”œâ”€â”€ searchService.ts # è”ç½‘æœç´¢æœåŠ¡ (Serper/Tavily/Brave)
â”‚   â”œâ”€â”€ fileParser.ts    # å‰ç«¯æ–‡ä»¶è§£æ (PDF/Docx -> Text) + å›¾ç‰‡å‹ç¼©
â”‚   â”œâ”€â”€ modelFetcher.ts  # è¿œç¨‹æ¨¡å‹åˆ—è¡¨è·å–
â”‚   â”œâ”€â”€ visionProxyService.ts # è§†è§‰ä»£ç† (è®©çº¯æ–‡æœ¬æ¨¡å‹"çœ‹"å›¾ç‰‡)
â”‚   â”œâ”€â”€ summaryService.ts# è‡ªåŠ¨èµ·åä¸è®°å¿†æ€»ç»“æœåŠ¡
â”‚   â”œâ”€â”€ ttsService.ts    # TTS è¯­éŸ³åˆæˆæœåŠ¡ (å¤šæœåŠ¡å•†é€‚é…)
â”‚   â””â”€â”€ entertainmentService.ts # å¨±ä¹å·¥å…· (éª°å­/å¡”ç½—ç‰Œ)
â”‚
â”œâ”€â”€ types.ts             # TypeScript ç±»å‹å®šä¹‰ (æ•°æ®å¥‘çº¦)
â”œâ”€â”€ constants.ts         # å¸¸é‡ã€é»˜è®¤å€¼ã€Logo æ˜ å°„
â”œâ”€â”€ App.tsx              # ä¸»æ§åˆ¶å™¨ (Controller)
â”œâ”€â”€ main.tsx             # å…¥å£æ–‡ä»¶
â””â”€â”€ index.css            # Tailwind æ ·å¼å¼•å…¥
```

---

## 3. æ ¸å¿ƒæ•°æ®æ¨¡å‹ (`types.ts`)

ç†è§£æ•°æ®æ¨¡å‹æ˜¯æ‰©å±•ç³»ç»Ÿçš„å…³é”®ã€‚

### 3.1 `ChatGroup` (ç¾¤ç»„) - V5.1 æ–°å¢
ç¾¤ç»„æ˜¯é¡¶å±‚å®¹å™¨ï¼ŒåŒ…å«å¤šä¸ªå¯¹è¯ï¼Œå…±äº«æˆå‘˜å’Œåœºæ™¯è®¾å®šã€‚
```typescript
interface ChatGroup {
  id: string;
  name: string;
  memberIds: string[];     // å…±äº«çš„æˆå‘˜åˆ—è¡¨
  scenario?: string;       // å…±äº«çš„å‰§æœ¬ (World View)
  memoryConfig: MemoryConfig; // å…±äº«çš„è®°å¿†é…ç½®
  entertainmentConfig?: EntertainmentConfig; // å¨±ä¹å·¥å…·é…ç½® (V5.3)
  createdAt: number;
}

interface EntertainmentConfig {
  enableDice: boolean;     // å¯ç”¨éª°å­ {{ROLL: XdY+Z}}
  enableTarot: boolean;    // å¯ç”¨å¡”ç½—ç‰Œ {{TAROT: N}}
  enablePM?: boolean;      // å¯ç”¨ç§è®¯åŠŸèƒ½ (V5.5)
}
```

### 3.2 `ChatSession` (å¯¹è¯)
å­˜å‚¨ä¸€ä¸ªå¯¹è¯çš„æ¶ˆæ¯è®°å½•ï¼Œå½’å±äºæŸä¸ªç¾¤ç»„ã€‚
```typescript
interface ChatSession {
  id: string;
  groupId: string;         // æ‰€å±ç¾¤ç»„
  name: string;
  messages: Message[];     // æ¶ˆæ¯åˆ—è¡¨
  lastUpdated: number;
  mutedAgentIds: string[]; // ç¦è¨€åå•
  mutedAgents: MuteInfo[]; // è¯¦ç»†ç¦è¨€ä¿¡æ¯ (å«è¿‡æœŸæ—¶é—´)
  yieldedAgentIds: string[]; // PASS è±å…åå•

  // ç‹¬ç«‹è®°å¿† (æ¯ä¸ªå¯¹è¯å•ç‹¬)
  summary?: string;        // é•¿æœŸè®°å¿†æ–‡æœ¬
  adminNotes?: string[];   // ç®¡ç†å‘˜ä¸´æ—¶ä¾¿ç­¾

  // è¾©è®º/å‘è¨€é¡ºåºæ¨¡å¼ (V5.4)
  debateConfig?: DebateConfig; // undefined = éšæœºæ¨¡å¼

  // ç²¾ç»†å¯è§æ€§æ§åˆ¶ (V5.5)
  agentVisibility?: Record<string, string[]>; // key=agentId, value=è¯¥agentçœ‹ä¸åˆ°çš„agentIdåˆ—è¡¨
  humanDisguise?: string[];    // è¢«æ ‡è®°ä¸º"äººç±»"çš„agentIdåˆ—è¡¨
}
```

### 3.5 `DebateConfig` (è¾©è®ºé…ç½®) - V5.4 æ–°å¢
ä¼šè¯çº§çš„å‘è¨€é¡ºåºé…ç½®ï¼Œæ”¯æŒéšæœºå’Œè¾©è®ºä¸¤ç§æ¨¡å¼ã€‚
```typescript
type TurnMode = 'random' | 'debate';
type DebateSide = 'pro' | 'con';

interface DebateAssignment {
  agentId: string;
  side: DebateSide;        // æ­£æ–¹ or åæ–¹
  order: number;           // 1-based, side å†…çš„å‘è¨€åºå·
}

interface DebateConfig {
  turnMode: TurnMode;
  assignments: DebateAssignment[];
  breathingTime?: number;  // ä¼šè¯çº§å‘è¨€é—´éš”è¦†ç›– (ms)ï¼Œundefined æ—¶ç”¨å…¨å±€å€¼
  currentTurnIndex: number;// å½“å‰è½®åˆ°ç¬¬å‡ ä¸ª (å±•å¹³åºåˆ—ä¸­çš„ç´¢å¼•)
}
```
*   **æ— éœ€ DB migration**ï¼šDexie å­˜ JSONï¼Œæ–°å­—æ®µ `undefined` = éšæœºæ¨¡å¼ï¼Œå‘åå…¼å®¹ã€‚

### 3.3 `Agent` (æ™ºèƒ½ä½“/è§’è‰²)
å®šä¹‰ä¸€ä¸ª AI äººæ ¼ã€‚
```typescript
interface Agent {
  id: string;
  name: string;
  providerId: string;      // å…³è”çš„ä¾›åº”å•†
  modelId: string;         // å…·ä½“æ¨¡å‹ (å¦‚ gpt-4o)
  systemPrompt: string;    // äººè®¾
  config: AgentConfig;     // ç‹¬ç«‹å‚æ•° (Temperature, MaxTokens, Reasoning)
  role: AgentRole;         // 'MEMBER' | 'ADMIN'
  isActive?: boolean;      // æ˜¯å¦å¯ç”¨
  enablePM?: boolean;      // è¯¥ agent æ˜¯å¦å¯ä»¥ä½¿ç”¨ç§è®¯ (V5.5)
  searchConfig?: SearchConfig; // æœç´¢å·¥å…·é…ç½®
  voiceId?: string;        // TTS éŸ³è‰² ID
  voiceProviderId?: string;// TTS æœåŠ¡å•† ID
}
```

### 3.4 `TTSProvider` (TTS æœåŠ¡å•†) - V5.2 æ–°å¢
ç±»ä¼¼äº `ApiProvider`ï¼Œç”¨äºç®¡ç†å¤šä¸ª TTS æœåŠ¡å•†ã€‚
```typescript
interface TTSProvider {
  id: string;
  name: string;            // æ˜¾ç¤ºåç§°
  type: TTSEngineType;     // 'browser' | 'openai' | 'elevenlabs' | 'minimax' | 'fishaudio' | 'azure'
  apiKey?: string;
  baseUrl?: string;        // è‡ªå®šä¹‰ç«¯ç‚¹
  voices: TTSVoice[];      // å¯ç”¨éŸ³è‰²åˆ—è¡¨
  pricePer1MChars?: number;// æ¯ç™¾ä¸‡å­—ç¬¦ä»·æ ¼ (USD)
  freeQuota?: string;      // å…è´¹é¢åº¦è¯´æ˜
}

interface TTSVoice {
  id: string;              // éŸ³è‰²æ ‡è¯†ç¬¦
  name: string;            // æ˜¾ç¤ºåç§°
  lang?: string;           // è¯­è¨€ä»£ç 
  gender?: 'male' | 'female' | 'neutral';
  isCustom?: boolean;      // ç”¨æˆ·è‡ªå®šä¹‰éŸ³è‰²
}

interface TTSSettings {
  enabled: boolean;
  activeProviderId?: string;  // å½“å‰é€‰æ‹©çš„æœåŠ¡å•†
  rate: number;               // è¯­é€Ÿ (0.5 - 2.0)
  volume: number;             // éŸ³é‡ (0 - 1)
  autoPlayNewMessages: boolean;
}
```

---

## 4. å…³é”®é€»è¾‘æµ (Logic Flow)

### 4.1 è‡ªåŠ¨å¯¹æˆ˜å¾ªç¯ (Auto-Play Loop)
ä½äº `App.tsx` çš„ `useEffect` ä¸­ï¼š
1.  **Check**: æ£€æŸ¥å¹¶å‘é” (`processingAgents`)ã€æš‚åœçŠ¶æ€ (`isAutoPlay`)ã€‚
2.  **Filter**: ç­›é€‰ç¬¦åˆæ¡ä»¶çš„ AIï¼ˆæœªç¦è¨€ã€æœª Yieldã€éä¸Šä¸€è½®å‘è¨€è€…ï¼‰ã€‚
    *   è¾©è®ºæ¨¡å¼ä¸‹è·³è¿‡ cooldown å’Œ lastSpeaker é™åˆ¶ï¼ˆé¡ºåºç”± turn sequence ä¿è¯ï¼‰ã€‚
3.  **@Mention Priority**: å¤„ç† @mention ä¼˜å…ˆçº§ï¼ˆè¾©è®ºæ¨¡å¼ä¸‹ AI çš„ @mention ä¸åŠ«æŒé¡ºåºï¼‰ã€‚
4.  **@Mention Decay**: éšæœºæ¨¡å¼ä¸‹ï¼ŒåŒä¸€å¯¹ agent è¿ç»­äº’ @ æ—¶æ¦‚ç‡é€’å‡ï¼ˆ100%â†’70%â†’40%â†’10%ï¼‰ï¼Œé˜²æ­¢äºŒäººè½¬ã€‚
5.  **Select**: æ ¹æ®æ¨¡å¼é€‰æ‹© agentï¼š
    *   **éšæœºæ¨¡å¼**: éšæœºé€‰æ‹©ã€‚
    *   **è¾©è®ºæ¨¡å¼**: æŒ‰å±•å¹³åºåˆ— (pro1â†’con1â†’pro2â†’con2...) é€‰æ‹©ä¸‹ä¸€ä¸ªï¼Œä½¿ç”¨ `debateTurnIndexRef` è·Ÿè¸ªè¿›åº¦ã€‚
6.  **Trigger**: è°ƒç”¨ `triggerAgentReply`ï¼Œä½¿ç”¨ä¼šè¯çº§ `breathingTime` è¦†ç›–ï¼ˆå¦‚æœ‰é…ç½®ï¼‰ã€‚

### 4.2 è§¦å‘å›å¤ (`triggerAgentReply`)
è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒè°ƒåº¦å‡½æ•°ï¼š
1.  **Lock**: å°† AI ID åŠ å…¥ `processingAgents`ã€‚
2.  **Signal**: åˆ›å»º `AbortController` ç”¨äºè¶…æ—¶ç†”æ–­æˆ–æ‰‹åŠ¨åœæ­¢ã€‚
3.  **Service Call**: æ ¹æ® `provider.type` è·¯ç”±åˆ°å¯¹åº”çš„ Service (`streamGeminiReply` ç­‰)ã€‚
4.  **Stream & Parse**: 
    *   æ¥æ”¶æµå¼æ•°æ®ã€‚
    *   **æŒ‡ä»¤è§£æ**ï¼šæ­£åˆ™æ‰«æ `{{PASS}}`, `{{REPLY:id}}`, `{{MUTE:name}}`, `{{NOTE:content}}`ã€‚
5.  **Commit**: ç”Ÿæˆå®Œæ¯•ï¼Œæ‰§è¡Œç®¡ç†æŒ‡ä»¤ï¼ˆå¦‚ç¦è¨€ï¼‰ï¼Œè®¡ç®— Token èŠ±è´¹ï¼Œæ›´æ–°çŠ¶æ€ï¼Œé‡Šæ”¾ Lockã€‚

### 4.3 æ–‡æœ¬æŒ‡ä»¤åè®® (Text Command Protocol)
ä¸ºäº†è®© AI èƒ½å¤Ÿæ“ä½œ UI åŠŸèƒ½ï¼ˆå¦‚ç¦è¨€ã€è®°ç¬”è®°ã€æœç´¢ï¼‰ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€å¥—åŸºäºæ–‡æœ¬çš„åè®®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤æ‚çš„ Function Callingã€‚è¿™ä¿è¯äº†è·¨æ¨¡å‹çš„æœ€å¤§å…¼å®¹æ€§ã€‚

**æ‰€æœ‰æŒ‡ä»¤åˆ—è¡¨ï¼š**
| æŒ‡ä»¤ | æƒé™ | è¯´æ˜ |
|------|------|------|
| `{{PASS}}` | æ‰€æœ‰ | è·³è¿‡æœ¬è½®å‘è¨€ |
| `{{REPLY: id}}` | æ‰€æœ‰ | å¼•ç”¨æŸæ¡æ¶ˆæ¯ |
| `{{SEARCH: query}}` | éœ€é…ç½® | AI ä¸»åŠ¨è”ç½‘æœç´¢ |
| `{{ROLL: XdY+Z}}` | éœ€å¼€å¯ | æŠ•æ·éª°å­ (å¦‚ 2d6+3) |
| `{{TAROT: N}}` | éœ€å¼€å¯ | æŠ½å– N å¼ å¡”ç½—ç‰Œ (æ”¯æŒæ­£é€†ä½) |
| `{{RES_PM_Name: content}}` | éœ€å¼€å¯ | å‘é€ç§è®¯ç»™æŒ‡å®šæˆå‘˜ (V5.5) |
| `{{MUTE: Name, Duration}}` | Admin | ç¦è¨€æˆå‘˜ (10min/1h/1d/æ°¸ä¹…) |
| `{{UNMUTE: Name}}` | Admin | è§£é™¤ç¦è¨€ |
| `{{NOTE: content}}` | Admin | æ·»åŠ è®°å¿†ä¾¿ç­¾ |
| `{{DELNOTE: keyword}}` | Admin | åˆ é™¤å«å…³é”®è¯çš„ä¾¿ç­¾ |
| `{{CLEARNOTES}}` | Admin | æ¸…ç©ºæ‰€æœ‰ä¾¿ç­¾ |

**æ‰§è¡Œæµç¨‹ï¼š**
*   **Prompt æ³¨å…¥**: åœ¨ `*Service.ts` ä¸­ï¼Œæˆ‘ä»¬å‘ŠçŸ¥è§’è‰²å¯ç”¨çš„æŒ‡ä»¤ã€‚
*   **æŒ‡ä»¤æ‹¦æˆª**: åœ¨ `App.tsx` çš„æµå¼è¯»å–å¾ªç¯ä¸­ï¼Œæ­£åˆ™åŒ¹é…åˆ°æŒ‡ä»¤åï¼š
    *   UI å±‚**éšè—**è¯¥æŒ‡ä»¤ï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰ã€‚
    *   ä»£ç å±‚**æ‰§è¡Œ**å¯¹åº”é€»è¾‘ã€‚

### 4.4 è”ç½‘æœç´¢æµç¨‹ (Search Flow) - V5.1 æ–°å¢
1.  **è§¦å‘æ–¹å¼**ï¼š
    *   ç”¨æˆ·è¾“å…¥ `/search å…³é”®è¯`
    *   AI è¾“å‡º `{{SEARCH: å…³é”®è¯}}`ï¼ˆéœ€åœ¨è§’è‰²è®¾ç½®ä¸­é…ç½®æœç´¢æœåŠ¡ï¼‰
2.  **æ‰§è¡Œ**: è°ƒç”¨ `searchService.performSearch`ï¼Œæ”¯æŒ Serper/Tavily/Brave/Metasoã€‚
3.  **ç»“æœæ³¨å…¥**: æœç´¢ç»“æœä½œä¸ºç³»ç»Ÿæ¶ˆæ¯æ’å…¥èŠå¤©ï¼Œå¹¶å†æ¬¡è§¦å‘ AI å›å¤ã€‚
4.  **é˜²å¾ªç¯**: ç¬¬äºŒæ¬¡è§¦å‘æ—¶ `disableSearch=true`ï¼ŒAI ä¸ä¼šå†çœ‹åˆ°æœç´¢å·¥å…·æç¤ºã€‚

### 4.5 è®°å¿†ä¸æ€»ç»“ç³»ç»Ÿ (Memory System)
1.  **è§¦å‘å™¨**: `App.tsx` ç›‘å¬ `messages.length`ã€‚å½“ `count % threshold === 0` æ—¶è§¦å‘ã€‚
2.  **æ‰§è¡Œ**: è°ƒç”¨ `summaryService.updateSessionSummary`ã€‚
3.  **åˆæˆ**: `Prompt = Old Summary + Admin Notes + Recent Messages`ã€‚
4.  **æ›´æ–°**: ç”Ÿæˆæ–°çš„ Summaryï¼Œå­˜å…¥ DBï¼Œæ¸…ç©º Admin Notesã€‚
5.  **é—­ç¯**: æ–°çš„ Summary ä¼šåœ¨ä¸‹ä¸€æ¬¡ API è°ƒç”¨æ—¶ä½œä¸º System Prompt æ³¨å…¥ï¼Œå®ç°è®°å¿†é—­ç¯ã€‚

### 4.6 ç¾¤ç»„å±‚çº§ç»“æ„ (Group Hierarchy) - V5.1 æ–°å¢
```
ç¾¤ç»„ (Group)           â†’ å…±äº«ï¼šæˆå‘˜ã€åœºæ™¯ã€è®°å¿†é…ç½®
â”œâ”€â”€ å¯¹è¯ 1 (Session)   â†’ ç‹¬ç«‹ï¼šæ¶ˆæ¯ã€æ‘˜è¦ã€ä¾¿ç­¾ã€ç¦è¨€
â”œâ”€â”€ å¯¹è¯ 2 (Session)
â””â”€â”€ å¯¹è¯ 3 (Session)
```
*   **UI**: å·¦ä¾§è¾¹æ æ˜¾ç¤ºä¸¤çº§æŠ˜å åˆ—è¡¨ã€‚
*   **æˆå‘˜ç®¡ç†**: å³ä¾§è¾¹æ æ“ä½œçš„æ˜¯ç¾¤ç»„çš„ `memberIds`ï¼Œå¯¹è¯¥ç¾¤ç»„ä¸‹æ‰€æœ‰å¯¹è¯ç”Ÿæ•ˆã€‚
*   **æ•°æ®è¿ç§»**: Dexie v2 è‡ªåŠ¨ä¸ºæ—§ Session åˆ›å»ºåŒå Groupã€‚

### 4.7 å›¾ç‰‡å‹ç¼© (Image Compression) - V5.1 æ–°å¢
Anthropic API é™åˆ¶å›¾ç‰‡ 5MBï¼Œå› æ­¤åœ¨ä¸Šä¼ æ—¶è‡ªåŠ¨å‹ç¼©ï¼š
1.  **æ£€æµ‹**: `fileParser.ts` è®¡ç®— Base64 å¤§å°ã€‚
2.  **å‹ç¼©**: ä½¿ç”¨ Canvas é™ä½è´¨é‡ (0.9â†’0.3) å’Œå°ºå¯¸ (1.0â†’0.25)ï¼Œè¾“å‡º JPEGã€‚
3.  **é…ç½®**: ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­å…³é—­æˆ–è°ƒæ•´é˜ˆå€¼ (é»˜è®¤ 4MB)ã€‚

### 4.8 å¨±ä¹å·¥å…·ç³»ç»Ÿ (Entertainment Tools) - V5.3 æ–°å¢
ä¸º TRPGã€å‰§æœ¬æ€ç­‰è§’è‰²æ‰®æ¼”åœºæ™¯æä¾›éª°å­å’Œå¡”ç½—ç‰ŒåŠŸèƒ½ã€‚

**éª°å­ç³»ç»Ÿ (Dice Rolling)ï¼š**
*   **è¯­æ³•**: `{{ROLL: XdY+Z}}` - X ä¸ª Y é¢éª°å­ + ä¿®æ­£å€¼ Z
*   **ç¤ºä¾‹**: `{{ROLL: 2d6+3}}` â†’ `2d6+3 = 11 (4+5+2)`
*   **å®ç°**: `entertainmentService.rollDice()` è§£æè¡¨è¾¾å¼å¹¶è¿”å›æ˜ç»†

**å¡”ç½—ç‰Œç³»ç»Ÿ (Tarot Cards)ï¼š**
*   **è¯­æ³•**: `{{TAROT: N}}` - æŠ½å– N å¼ ç‰Œ
*   **ç‰Œåº“**: 22 å¼ å¤§é˜¿å¡çº³ç‰Œ (Major Arcana)
*   **æ­£é€†ä½**: æ¯å¼ ç‰Œ 50% æ¦‚ç‡é€†ä½ï¼Œæ˜¾ç¤ºä¸º "ğŸ”® The Fool (Reversed)"
*   **ä¸‰ç‰Œé˜µ**: å½“ N=3 æ—¶ï¼Œè‡ªåŠ¨æ ‡æ³¨ Past / Present / Future

**é…ç½®ä¸æç¤ºè¯æ³¨å…¥ï¼š**
*   ç¾¤ç»„è®¾ç½®ä¸­å¯å•ç‹¬å¼€å…³éª°å­/å¡”ç½—åŠŸèƒ½
*   å½“åŠŸèƒ½å¼€å¯æ—¶ï¼Œè‡ªåŠ¨åœ¨ System Prompt ä¸­æ³¨å…¥ä½¿ç”¨è¯´æ˜
*   AI å®Œæˆè¾“å‡ºåï¼Œ`App.tsx` è§£ææŒ‡ä»¤å¹¶æ’å…¥ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤ºç»“æœ

### 4.9 TTS è¯­éŸ³åˆæˆç³»ç»Ÿ (Text-to-Speech) - V5.2 æ–°å¢
æ”¯æŒå¤šç§ TTS æœåŠ¡å•†ï¼Œå®ç°æ¶ˆæ¯æœ—è¯»åŠŸèƒ½ã€‚

**æ”¯æŒçš„æœåŠ¡å•†ï¼š**
| æœåŠ¡å•† | ç±»å‹ | ä»·æ ¼ (æ¯ç™¾ä¸‡å­—ç¬¦) | ç‰¹ç‚¹ |
|--------|------|------------------|------|
| Browser | æµè§ˆå™¨åŸç”Ÿ | å…è´¹ | æ— éœ€ APIï¼Œä¾èµ–ç³»ç»Ÿè¯­éŸ³ |
| OpenAI | äº‘ç«¯ | $15 | é«˜è´¨é‡ï¼Œæ”¯æŒ 6 ç§éŸ³è‰² |
| ElevenLabs | äº‘ç«¯ | $30 | æœ€è‡ªç„¶ï¼Œæ”¯æŒè‡ªå®šä¹‰éŸ³è‰²å…‹éš† |
| MiniMax | äº‘ç«¯ | $5 | æ€§ä»·æ¯”é«˜ï¼Œä¸­æ–‡ä¼˜åŒ– |
| Fish Audio | äº‘ç«¯ | $10 | å¼€æºå‹å¥½ï¼Œæ”¯æŒè‡ªè®­ç»ƒ |
| Azure | äº‘ç«¯ | $15 | ä¼ä¸šçº§ï¼Œå¤šè¯­è¨€æ”¯æŒ |

**æ’­æ”¾æ¨¡å¼ï¼š**
*   **å•æ¡æ’­æ”¾**: ç‚¹å‡»æ¶ˆæ¯æ—çš„æ’­æ”¾æŒ‰é’®ã€‚
*   **è¿ç»­æ’­æ”¾**: ä»æŸæ¡æ¶ˆæ¯å¼€å§‹ï¼Œè‡ªåŠ¨æ’­æ”¾åç»­æ‰€æœ‰æ¶ˆæ¯ã€‚
*   **è‡ªåŠ¨æ’­æ”¾**: æ–°æ¶ˆæ¯ç”Ÿæˆåè‡ªåŠ¨æœ—è¯»ã€‚

**éŸ³è‰²åˆ†é…é€»è¾‘ï¼š**
1.  ä¼˜å…ˆä½¿ç”¨ Agent é…ç½®çš„ `voiceId` + `voiceProviderId`ã€‚
2.  è‹¥æœªé…ç½®ï¼Œåˆ™ä»å½“å‰æœåŠ¡å•†çš„éŸ³è‰²åˆ—è¡¨ä¸­éšæœºåˆ†é…ã€‚
3.  ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨é»˜è®¤éŸ³è‰²ã€‚

**æ‰§è¡Œæµç¨‹ï¼š**
```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾ â†’ ttsService.speak(text, voiceId, provider)
  â†’ æ ¹æ® provider.type è·¯ç”±åˆ°å¯¹åº”å®ç°
  â†’ playOpenAITTS / playElevenLabsTTS / playMiniMaxTTS / ...
  â†’ è¿”å› { chars, cost } ç”¨äºè´¹ç”¨ç»Ÿè®¡
```

**è‡ªå®šä¹‰éŸ³è‰²ç®¡ç†ï¼š**
*   ç”¨æˆ·å¯æ‰‹åŠ¨æ·»åŠ æœåŠ¡å•†æœªè‡ªåŠ¨è·å–çš„éŸ³è‰²ï¼ˆè¾“å…¥åç§° + IDï¼‰ã€‚
*   æ”¯æŒä¸ºæ¯ä¸ª Agent å•ç‹¬æŒ‡å®šéŸ³è‰²ã€‚

### 4.10 è¾©è®º/å‘è¨€é¡ºåºæ¨¡å¼ (Debate Turn Mode) - V5.4 æ–°å¢
æ”¯æŒåœ¨ä¼šè¯çº§åˆ«é…ç½® agent çš„å‘è¨€é¡ºåºï¼Œé€‚ç”¨äºæ­£å¼è¾©è®ºã€è§’è‰²å¯¹æŠ—ç­‰åœºæ™¯ã€‚

**å‘è¨€åºåˆ—æ„å»ºï¼š**
```
assignments: [pro1, pro2, con1, con2, con3]
  â†’ buildDebateTurnSequence()
  â†’ [pro1, con1, pro2, con2, con3]  (äº¤æ›¿æ’å…¥)
```

**UI é…ç½® (RightSidebar)ï¼š**
*   æ¨¡å¼åˆ‡æ¢ï¼šéšæœº / è¾©è®º
*   åˆ‡æ¢åˆ°è¾©è®ºæ—¶è‡ªåŠ¨å°†æˆå‘˜äº¤æ›¿åˆ†é…æ­£åæ–¹
*   æ”¯æŒæ‹–åŠ¨æ’åº (ä¸Š/ä¸‹ç®­å¤´) å’Œåˆ‡æ¢é˜µè¥
*   å¯è®¾ç½®ä¼šè¯çº§å‘è¨€é—´éš”è¦†ç›–
*   Agent å¡ç‰‡ä¸Šæ˜¾ç¤ºé˜µè¥å¾½ç« ï¼ˆæ­£1ã€å2 ç­‰ï¼‰

**Prompt æ³¨å…¥ï¼š**
è¾©è®ºæ¨¡å¼ä¸‹ï¼Œ`triggerAgentReply` è‡ªåŠ¨åœ¨ `scenario` æœ«å°¾è¿½åŠ é˜µè¥ä¿¡æ¯ï¼š
```
[è¾©è®ºæ¨¡å¼]
å½“å‰ä¸ºè¾©è®ºæ¨¡å¼ï¼Œä½ è¢«åˆ†é…ä¸ºã€æ­£æ–¹ç¬¬1å·è¾©æ‰‹ã€‘ã€‚
æ­£æ–¹æˆå‘˜: 1. Gemini, 2. GPT-4o
åæ–¹æˆå‘˜: 1. DeepSeek, 2. Claude
è¯·ç«™åœ¨æ­£æ–¹çš„ç«‹åœºè¿›è¡Œè®ºè¿°ï¼Œä¸å¯¹æ–¹é˜µè¥å±•å¼€è¾©è®ºã€‚
```
*   æ³¨å…¥åˆ° `scenario` è€Œéå•ç‹¬å‚æ•°ï¼Œä¸‰ä¸ª service æ–‡ä»¶æ— éœ€ä¿®æ”¹ã€‚

**é˜²äºŒäººè½¬æœºåˆ¶ (@Mention Decay)ï¼š**
*   éšæœºæ¨¡å¼ä¸‹ï¼Œ`mentionPairRef` è·Ÿè¸ªåŒä¸€å¯¹ agent è¿ç»­äº’ @ æ¬¡æ•°ã€‚
*   è¡°å‡æ›²çº¿ï¼š`prob = max(0.1, 1 - count * 0.3)` â†’ ç¬¬ 4 æ¬¡èµ·ä»… 10%ã€‚
*   æ¦‚ç‡ä¸é€šè¿‡æ—¶ fall through åˆ°éšæœºé€‰äººã€‚
*   è¾©è®ºæ¨¡å¼ä¸‹ç›´æ¥è·³è¿‡ AI @mention ä¼˜å…ˆçº§ï¼Œå®Œå…¨ç”± turn sequence æ§åˆ¶ã€‚

**å…³é”®å®ç°ç»†èŠ‚ï¼š**
*   `currentTurnIndex` ä½¿ç”¨ `useRef` è€Œé session stateï¼Œé¿å…åœ¨ autoplay `useEffect` ä¸­è§¦å‘æ— é™å¾ªç¯ã€‚
*   åˆ‡æ¢ä¼šè¯æ—¶ä» session çš„ `debateConfig.currentTurnIndex` åŒæ­¥åˆ° refã€‚
*   æ¸…ç©ºæ¶ˆæ¯æ—¶é‡ç½® ref å’Œ session ä¸­çš„ indexã€‚
*   ç§»é™¤ agent æ—¶è‡ªåŠ¨æ¸…ç†å¯¹åº” assignmentã€‚

### 4.11 ç§è®¯ä¸ç²¾ç»†å¯è§æ€§ç³»ç»Ÿ (PM & Visibility) - V5.5 æ–°å¢
æ”¯æŒ AI å’Œäººç±»ä¹‹é—´çš„ç§å¯†é€šä¿¡ï¼Œä»¥åŠä¼šè¯çº§çš„å¯è§æ€§æ§åˆ¶ã€‚

**ç§è®¯ (Private Message) ç³»ç»Ÿï¼š**
*   **AI å‘é€ PM**: ä½¿ç”¨ `{{RES_PM_Name: content}}`ï¼Œå¯ä¸ `{{RESPONSE:}}` åŒæ—¶ä½¿ç”¨ï¼ˆåŒé‡è¾“å‡ºï¼‰ã€‚
*   **äººç±»å‘é€ PM**: è¾“å…¥æ¡†æ—çš„ PM æŒ‰é’®é€‰æ‹©ç›®æ ‡ï¼Œå‘é€åä»…ç›®æ ‡å’Œè‡ªå·±å¯è§ã€‚
*   **å¯è§æ€§è§„åˆ™**: PM æ¶ˆæ¯ä»… sender + target + äººç±»ç”¨æˆ· å¯è§ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼ˆé«˜äº OPEN/BLIND æ¨¡å¼ï¼‰ã€‚
*   **åŒé‡è¾“å‡º**: AI å¯åŒæ—¶å‘å…¬å¼€æ¶ˆæ¯å’Œç§è®¯ï¼Œä¿å­˜ä¸ºä¸¤æ¡ç‹¬ç«‹æ¶ˆæ¯ã€‚
*   **UI è¡¨ç°**: PM æ¶ˆæ¯æ–‡å­—æ¸²æŸ“ä¸ºç´«è‰²ï¼Œåå­—æ—æ˜¾ç¤ºç´«è‰²å¾½ç«  `ç§è®¯â†’ç›®æ ‡å`ã€‚

**å¯è§æ€§è¿‡æ»¤ä¼˜å…ˆçº§ (ä¸‰ä¸ª service ç»Ÿä¸€)ï¼š**
```
1. ç³»ç»Ÿæ¶ˆæ¯ â†’ å§‹ç»ˆå¯è§
2. PM æ¶ˆæ¯ â†’ ä»… sender å’Œ target å¯è§
3. ç”¨æˆ·æ¶ˆæ¯ â†’ å§‹ç»ˆå¯è§
4. è‡ªå·±çš„æ¶ˆæ¯ â†’ å§‹ç»ˆå¯è§
5. å•å‘å±è”½ â†’ agentVisibility é…ç½®
6. å…¨å±€æ¨¡å¼ â†’ OPEN (å…¨å¯è§) / BLIND (ä»…çœ‹åˆ°è‡ªå·±)
```

**å•å‘å¯è§æ€§å±è”½ï¼š**
*   ä¼šè¯çº§é…ç½® `agentVisibility: Record<string, string[]>`
*   RightSidebar ä¸­æ¯ä¸ª agent å¯æŠ˜å é…ç½®"çœ‹ä¸åˆ°è°çš„æ¶ˆæ¯"
*   PM ä¼˜å…ˆçº§é«˜äºå±è”½ï¼ˆè¢«å±è”½çš„äººå‘ PM ä»å¯é€è¾¾ï¼‰

**äººç±»ä¼ªè£… (Human Disguise)ï¼š**
*   ä¼šè¯çº§ `humanDisguise: string[]`ï¼Œè¢«æ ‡è®°çš„ agent åœ¨å…¶ä»– AI çš„æˆå‘˜åˆ—è¡¨ä¸­æ˜¾ç¤ºä¸º "(Human)"
*   ä¸å½±å“è‡ªèº«è§†è§’ï¼ˆagent è‡ªå·±ä»çŸ¥é“è‡ªå·±æ˜¯ AIï¼‰

**Auto-Play ä¸ PM äº¤äº’ï¼š**
*   PM å‘ç»™äººç±» â†’ ä¸è§¦å‘ä»»ä½• agent
*   PM å‘ç»™ AI â†’ ä»…è§¦å‘ç›®æ ‡ agent å›å¤
*   åŒé‡è¾“å‡º â†’ ä»¥å…¬å¼€æ¶ˆæ¯ä¸ºå‡†è§¦å‘ auto-playï¼ŒPM éƒ¨åˆ†é™é»˜

**Anthropic Thinking Mode å…¼å®¹ï¼š**
*   PM æ¶ˆæ¯å’Œå†å²ä¸­ç¼ºå°‘ thinking block çš„ assistant æ¶ˆæ¯ä¼šè¢«é™çº§ä¸º user è§’è‰²çš„å›å¿†æ³¨é‡Š
*   é¿å…"ä¸­æ¯’"ï¼šä¸€æ—¦ thinking è¢«æ„å¤–ç¦ç”¨ï¼Œä¸ä¼šå› æ—§æ¶ˆæ¯æ°¸ä¹…æ— æ³•æ¢å¤
*   `shouldEnableThinking` åªçœ‹ agent é…ç½®ï¼Œä¸å†æ£€æŸ¥å†å²å®Œæ•´æ€§

---

## 5. æ‰©å±•æŒ‡å—ï¼šæ„å»ºè®°å¿†ä¸åç«¯ (Future Roadmap)

å¦‚æœæ‚¨è®¡åˆ’å¼•å…¥**å‘é‡æ•°æ®åº“ (Vector DB)** æˆ– **åç«¯æ•°æ®åº“**ï¼Œè¯·å‚è€ƒä»¥ä¸‹é‡æ„è·¯å¾„ï¼š

### é˜¶æ®µä¸€ï¼šæŠ½ç¦»çŠ¶æ€é€»è¾‘ (Refactor)
ç›®å‰ `App.tsx` æ‰¿æ‹…äº†è¿‡å¤šçš„ Controller èŒè´£ã€‚
*   **ç›®æ ‡**ï¼šå°†èŠå¤©é€»è¾‘æŠ½ç¦»ä¸º Custom Hookï¼Œä¾‹å¦‚ `useChatEngine`ã€‚
*   **å¥½å¤„**ï¼š`App.tsx` åªè´Ÿè´£å¸ƒå±€ï¼Œé€»è¾‘å±‚æ›´æ¸…æ™°ï¼Œæ–¹ä¾¿æ¥å…¥ä¸åŒçš„æ•°æ®æºã€‚

### é˜¶æ®µäºŒï¼šå¼•å…¥å‘é‡æ•°æ®åº“ (RAG Integration)
ç›®å‰çš„ä¸Šä¸‹æ–‡æ˜¯åŸºäº**æ»‘åŠ¨çª—å£ (Sliding Window)**ã€‚è¦è®© AI è®°ä½ 1000 æ¡ä¹‹å‰çš„ç»†èŠ‚ï¼š
1.  **ä¿®æ”¹ç‚¹**ï¼š`services/*Service.ts`ã€‚
2.  **åŠ¨ä½œ**ï¼š
    *   åœ¨æ„å»º `formattedMessages` ä¹‹å‰ï¼Œæˆªå–ç”¨æˆ·çš„ Queryã€‚
    *   å°† Query å‘é€åˆ°å‘é‡æ•°æ®åº“ (å¦‚ Pinecone, æˆ–æµè§ˆå™¨æœ¬åœ°çš„ Transformers.js + Voy)ã€‚
    *   æ£€ç´¢ç›¸å…³å†å²è®°å½• (Relevant Memories)ã€‚
    *   å°†æ£€ç´¢åˆ°çš„è®°å½•æ’å…¥åˆ° System Prompt çš„ `[Relevant History]` åŒºå—ä¸­ã€‚

### é˜¶æ®µä¸‰ï¼šä» IndexedDB è¿ç§»åˆ° PostgreSQL/Supabase
å¦‚æœè¦æŠŠè¿™æ˜¯ä¸€ä¸ªå•æœºåº”ç”¨å˜æˆå¤šäººåœ¨çº¿åº”ç”¨ï¼š
1.  **æ›¿æ¢ `services/db.ts`**ï¼š
    *   ä¿æŒæ–¹æ³•åä¸å˜ (`loadAllData`, `saveCollection`)ã€‚
    *   å°†å†…éƒ¨å®ç°ä» `dexie` æ›¿æ¢ä¸º `fetch('/api/...')` æˆ– `supabase-js` å®¢æˆ·ç«¯ã€‚

---

## 6. è°ƒè¯•ä¸æ„å»º

*   **æœ¬åœ°è¿è¡Œ**: `npm run dev`
*   **æ„å»ºç”Ÿäº§åŒ…**: `npm run build`

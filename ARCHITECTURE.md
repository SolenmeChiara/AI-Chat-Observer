# ğŸ—ï¸ é¡¹ç›®æ¶æ„æ–‡æ¡£ (Project Architecture)

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† **AI ç¾¤èŠè§‚å¯Ÿä¼š (V5.3)** çš„ä»£ç ç»“æ„ã€æ•°æ®æµå‘åŠè®¾è®¡ç†å¿µã€‚æ—¨åœ¨å¸®åŠ©å¼€å‘è€…å¿«é€Ÿç†è§£ç³»ç»Ÿï¼Œå¹¶ä¸ºåç»­å¼•å…¥ **å‘é‡æ•°æ®åº“ (Vector DB)**ã€**é•¿æœŸè®°å¿† (Long-term Memory)** æˆ– **åç«¯æœåŠ¡** æä¾›æŒ‡å¯¼ã€‚

**V5.3 æ–°å¢åŠŸèƒ½ï¼š**
- å¨±ä¹å·¥å…·ï¼šéª°å­ `{{ROLL: XdY+Z}}` å’Œå¡”ç½—ç‰Œ `{{TAROT: N}}`
- ç¾¤ç»„çº§å¨±ä¹åŠŸèƒ½å¼€å…³
- è‡ªåŠ¨æç¤ºè¯æ³¨å…¥ (AI è‡ªåŠ¨è·çŸ¥å¯ç”¨çš„å¨±ä¹å·¥å…·)

**V5.2 åŠŸèƒ½ï¼š**
- å¤šæœåŠ¡å•† TTS è¯­éŸ³åˆæˆ (Browser/OpenAI/ElevenLabs/MiniMax/Fish Audio/Azure)
- è‡ªå®šä¹‰éŸ³è‰²ç®¡ç†ä¸ Agent éŸ³è‰²åˆ†é…
- å…¨å±€å±•å¼€/æŠ˜å æ€ç»´é“¾æŒ‰é’®
- è¶…æ—¶æ—¶é—´æ»‘å—æ‰©å±•è‡³ 5 åˆ†é’Ÿ

---

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

æœ¬é¡¹ç›®é‡‡ç”¨ **Local-First (æœ¬åœ°ä¼˜å…ˆ)** ä¸ **Serverless (æ— åç«¯)** æ¶æ„ï¼š

*   **çŠ¶æ€ç®¡ç†**ï¼šReact `useState` + `useRef` æ§åˆ¶å®æ—¶äº¤äº’ä¸æµå¼å“åº”ã€‚
*   **æŒä¹…åŒ–**ï¼šä½¿ç”¨ **IndexedDB (Dexie.js)** ä½œä¸ºæœ¬åœ°æ•°æ®åº“ï¼Œæ‰€æœ‰æ•°æ®ï¼ˆAPI Keyã€é…ç½®ã€èŠå¤©è®°å½•ï¼‰å‡å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ç«¯ã€‚
*   **é€»è¾‘åˆ†å±‚**ï¼šUI ç»„ä»¶åªè´Ÿè´£æ¸²æŸ“ï¼Œå¤æ‚é€»è¾‘å°è£…åœ¨ `services/` ç›®å½•ä¸­ã€‚
*   **å¤šæ€é€‚é…**ï¼šé€šè¿‡é€‚é…å™¨æ¨¡å¼ç»Ÿä¸€å¤„ç† Google Geminiã€OpenAIã€Anthropic ç­‰ä¸åŒ API çš„è¾“å…¥è¾“å‡ºå·®å¼‚ã€‚

---

## 2. ç›®å½•ç»“æ„è¯´æ˜

```text
src/
â”œâ”€â”€ components/          # UI ç»„ä»¶å±‚
â”‚   â”œâ”€â”€ ChatBubble.tsx   # æ ¸å¿ƒç»„ä»¶ï¼šè´Ÿè´£æ¸²æŸ“æ¶ˆæ¯ã€Markdownã€æ€ç»´é“¾ã€é™„ä»¶
â”‚   â”œâ”€â”€ Sidebar.tsx      # å·¦ä¾§æ ï¼šå…¨å±€é…ç½®ã€è§’è‰²ç¼–è¾‘ã€ä¼šè¯åˆ‡æ¢
â”‚   â””â”€â”€ RightSidebar.tsx # å³ä¾§æ ï¼šç¾¤æˆå‘˜ç®¡ç†ã€å¿«æ·æ“ä½œ
â”‚
â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®å±‚ (Service Layer)
â”‚   â”œâ”€â”€ db.ts            # IndexedDB æ•°æ®åº“ç®¡ç† (CRUD)
â”‚   â”œâ”€â”€ geminiService.ts # Gemini API é€‚é…å™¨ (å« Prompt æ³¨å…¥)
â”‚   â”œâ”€â”€ openaiService.ts # OpenAI å…¼å®¹æ¥å£é€‚é…å™¨ (å« Prompt æ³¨å…¥)
â”‚   â”œâ”€â”€ anthropicService.ts # Claude åŸç”Ÿ API é€‚é…å™¨ (å« Prompt æ³¨å…¥)
â”‚   â”œâ”€â”€ searchService.ts # è”ç½‘æœç´¢æœåŠ¡ (Serper/Tavily/Brave)
â”‚   â”œâ”€â”€ fileParser.ts    # å‰ç«¯æ–‡ä»¶è§£æ (PDF/Docx -> Text) + å›¾ç‰‡å‹ç¼©
â”‚   â”œâ”€â”€ modelFetcher.ts  # è¿œç¨‹æ¨¡å‹åˆ—è¡¨è·å–
â”‚   â”œâ”€â”€ visionProxyService.ts # è§†è§‰ä»£ç† (è®©çº¯æ–‡æœ¬æ¨¡å‹"çœ‹"å›¾ç‰‡)
â”‚   â”œâ”€â”€ summaryService.ts# è‡ªåŠ¨èµ·åä¸è®°å¿†æ€»ç»“æœåŠ¡
â”‚   â”œâ”€â”€ ttsService.ts    # TTS è¯­éŸ³åˆæˆæœåŠ¡ (å¤šæœåŠ¡å•†é€‚é…)
â”‚   â””â”€â”€ entertainmentService.ts # å¨±ä¹å·¥å…· (éª°å­/å¡”ç½—ç‰Œ)
â”‚
â”œâ”€â”€ types.ts             # TypeScript ç±»å‹å®šä¹‰ (æ•°æ®å¥‘çº¦)
â”œâ”€â”€ constants.ts         # å¸¸é‡ã€é»˜è®¤å€¼ã€Logo æ˜ å°„
â”œâ”€â”€ App.tsx              # ä¸»æ§åˆ¶å™¨ (Controller)
â”œâ”€â”€ main.tsx             # å…¥å£æ–‡ä»¶
â””â”€â”€ index.css            # Tailwind æ ·å¼å¼•å…¥
```

---

## 3. æ ¸å¿ƒæ•°æ®æ¨¡å‹ (`types.ts`)

ç†è§£æ•°æ®æ¨¡å‹æ˜¯æ‰©å±•ç³»ç»Ÿçš„å…³é”®ã€‚

### 3.1 `ChatGroup` (ç¾¤ç»„) - V5.1 æ–°å¢
ç¾¤ç»„æ˜¯é¡¶å±‚å®¹å™¨ï¼ŒåŒ…å«å¤šä¸ªå¯¹è¯ï¼Œå…±äº«æˆå‘˜å’Œåœºæ™¯è®¾å®šã€‚
```typescript
interface ChatGroup {
  id: string;
  name: string;
  memberIds: string[];     // å…±äº«çš„æˆå‘˜åˆ—è¡¨
  scenario?: string;       // å…±äº«çš„å‰§æœ¬ (World View)
  memoryConfig: MemoryConfig; // å…±äº«çš„è®°å¿†é…ç½®
  entertainmentConfig?: EntertainmentConfig; // å¨±ä¹å·¥å…·é…ç½® (V5.3)
  createdAt: number;
}

interface EntertainmentConfig {
  enableDice: boolean;     // å¯ç”¨éª°å­ {{ROLL: XdY+Z}}
  enableTarot: boolean;    // å¯ç”¨å¡”ç½—ç‰Œ {{TAROT: N}}
}
```

### 3.2 `ChatSession` (å¯¹è¯)
å­˜å‚¨ä¸€ä¸ªå¯¹è¯çš„æ¶ˆæ¯è®°å½•ï¼Œå½’å±äºæŸä¸ªç¾¤ç»„ã€‚
```typescript
interface ChatSession {
  id: string;
  groupId: string;         // æ‰€å±ç¾¤ç»„
  name: string;
  messages: Message[];     // æ¶ˆæ¯åˆ—è¡¨
  lastUpdated: number;
  mutedAgentIds: string[]; // ç¦è¨€åå•
  mutedAgents: MuteInfo[]; // è¯¦ç»†ç¦è¨€ä¿¡æ¯ (å«è¿‡æœŸæ—¶é—´)
  yieldedAgentIds: string[]; // PASS è±å…åå•

  // ç‹¬ç«‹è®°å¿† (æ¯ä¸ªå¯¹è¯å•ç‹¬)
  summary?: string;        // é•¿æœŸè®°å¿†æ–‡æœ¬
  adminNotes?: string[];   // ç®¡ç†å‘˜ä¸´æ—¶ä¾¿ç­¾
}
```

### 3.3 `Agent` (æ™ºèƒ½ä½“/è§’è‰²)
å®šä¹‰ä¸€ä¸ª AI äººæ ¼ã€‚
```typescript
interface Agent {
  id: string;
  name: string;
  providerId: string;      // å…³è”çš„ä¾›åº”å•†
  modelId: string;         // å…·ä½“æ¨¡å‹ (å¦‚ gpt-4o)
  systemPrompt: string;    // äººè®¾
  config: AgentConfig;     // ç‹¬ç«‹å‚æ•° (Temperature, MaxTokens, Reasoning)
  role: AgentRole;         // 'MEMBER' | 'ADMIN'
  isActive?: boolean;      // æ˜¯å¦å¯ç”¨
  searchConfig?: SearchConfig; // æœç´¢å·¥å…·é…ç½®
  voiceId?: string;        // TTS éŸ³è‰² ID
  voiceProviderId?: string;// TTS æœåŠ¡å•† ID
}
```

### 3.4 `TTSProvider` (TTS æœåŠ¡å•†) - V5.2 æ–°å¢
ç±»ä¼¼äº `ApiProvider`ï¼Œç”¨äºç®¡ç†å¤šä¸ª TTS æœåŠ¡å•†ã€‚
```typescript
interface TTSProvider {
  id: string;
  name: string;            // æ˜¾ç¤ºåç§°
  type: TTSEngineType;     // 'browser' | 'openai' | 'elevenlabs' | 'minimax' | 'fishaudio' | 'azure'
  apiKey?: string;
  baseUrl?: string;        // è‡ªå®šä¹‰ç«¯ç‚¹
  voices: TTSVoice[];      // å¯ç”¨éŸ³è‰²åˆ—è¡¨
  pricePer1MChars?: number;// æ¯ç™¾ä¸‡å­—ç¬¦ä»·æ ¼ (USD)
  freeQuota?: string;      // å…è´¹é¢åº¦è¯´æ˜
}

interface TTSVoice {
  id: string;              // éŸ³è‰²æ ‡è¯†ç¬¦
  name: string;            // æ˜¾ç¤ºåç§°
  lang?: string;           // è¯­è¨€ä»£ç 
  gender?: 'male' | 'female' | 'neutral';
  isCustom?: boolean;      // ç”¨æˆ·è‡ªå®šä¹‰éŸ³è‰²
}

interface TTSSettings {
  enabled: boolean;
  activeProviderId?: string;  // å½“å‰é€‰æ‹©çš„æœåŠ¡å•†
  rate: number;               // è¯­é€Ÿ (0.5 - 2.0)
  volume: number;             // éŸ³é‡ (0 - 1)
  autoPlayNewMessages: boolean;
}
```

---

## 4. å…³é”®é€»è¾‘æµ (Logic Flow)

### 4.1 è‡ªåŠ¨å¯¹æˆ˜å¾ªç¯ (Auto-Play Loop)
ä½äº `App.tsx` çš„ `useEffect` ä¸­ï¼š
1.  **Check**: æ£€æŸ¥å¹¶å‘é” (`processingAgents`)ã€æš‚åœçŠ¶æ€ (`isAutoPlay`)ã€‚
2.  **Select**: ç­›é€‰ç¬¦åˆæ¡ä»¶çš„ AIï¼ˆæœªç¦è¨€ã€æœª Yieldã€éä¸Šä¸€è½®å‘è¨€è€…ï¼‰ã€‚
3.  **Trigger**: éšæœºé€‰æ‹©ä¸€ä¸ª AIï¼Œè°ƒç”¨ `triggerAgentReply`ã€‚

### 4.2 è§¦å‘å›å¤ (`triggerAgentReply`)
è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒè°ƒåº¦å‡½æ•°ï¼š
1.  **Lock**: å°† AI ID åŠ å…¥ `processingAgents`ã€‚
2.  **Signal**: åˆ›å»º `AbortController` ç”¨äºè¶…æ—¶ç†”æ–­æˆ–æ‰‹åŠ¨åœæ­¢ã€‚
3.  **Service Call**: æ ¹æ® `provider.type` è·¯ç”±åˆ°å¯¹åº”çš„ Service (`streamGeminiReply` ç­‰)ã€‚
4.  **Stream & Parse**: 
    *   æ¥æ”¶æµå¼æ•°æ®ã€‚
    *   **æŒ‡ä»¤è§£æ**ï¼šæ­£åˆ™æ‰«æ `{{PASS}}`, `{{REPLY:id}}`, `{{MUTE:name}}`, `{{NOTE:content}}`ã€‚
5.  **Commit**: ç”Ÿæˆå®Œæ¯•ï¼Œæ‰§è¡Œç®¡ç†æŒ‡ä»¤ï¼ˆå¦‚ç¦è¨€ï¼‰ï¼Œè®¡ç®— Token èŠ±è´¹ï¼Œæ›´æ–°çŠ¶æ€ï¼Œé‡Šæ”¾ Lockã€‚

### 4.3 æ–‡æœ¬æŒ‡ä»¤åè®® (Text Command Protocol)
ä¸ºäº†è®© AI èƒ½å¤Ÿæ“ä½œ UI åŠŸèƒ½ï¼ˆå¦‚ç¦è¨€ã€è®°ç¬”è®°ã€æœç´¢ï¼‰ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€å¥—åŸºäºæ–‡æœ¬çš„åè®®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤æ‚çš„ Function Callingã€‚è¿™ä¿è¯äº†è·¨æ¨¡å‹çš„æœ€å¤§å…¼å®¹æ€§ã€‚

**æ‰€æœ‰æŒ‡ä»¤åˆ—è¡¨ï¼š**
| æŒ‡ä»¤ | æƒé™ | è¯´æ˜ |
|------|------|------|
| `{{PASS}}` | æ‰€æœ‰ | è·³è¿‡æœ¬è½®å‘è¨€ |
| `{{REPLY: id}}` | æ‰€æœ‰ | å¼•ç”¨æŸæ¡æ¶ˆæ¯ |
| `{{SEARCH: query}}` | éœ€é…ç½® | AI ä¸»åŠ¨è”ç½‘æœç´¢ |
| `{{ROLL: XdY+Z}}` | éœ€å¼€å¯ | æŠ•æ·éª°å­ (å¦‚ 2d6+3) |
| `{{TAROT: N}}` | éœ€å¼€å¯ | æŠ½å– N å¼ å¡”ç½—ç‰Œ (æ”¯æŒæ­£é€†ä½) |
| `{{MUTE: Name, Duration}}` | Admin | ç¦è¨€æˆå‘˜ (10min/1h/1d/æ°¸ä¹…) |
| `{{UNMUTE: Name}}` | Admin | è§£é™¤ç¦è¨€ |
| `{{NOTE: content}}` | Admin | æ·»åŠ è®°å¿†ä¾¿ç­¾ |
| `{{DELNOTE: keyword}}` | Admin | åˆ é™¤å«å…³é”®è¯çš„ä¾¿ç­¾ |
| `{{CLEARNOTES}}` | Admin | æ¸…ç©ºæ‰€æœ‰ä¾¿ç­¾ |

**æ‰§è¡Œæµç¨‹ï¼š**
*   **Prompt æ³¨å…¥**: åœ¨ `*Service.ts` ä¸­ï¼Œæˆ‘ä»¬å‘ŠçŸ¥è§’è‰²å¯ç”¨çš„æŒ‡ä»¤ã€‚
*   **æŒ‡ä»¤æ‹¦æˆª**: åœ¨ `App.tsx` çš„æµå¼è¯»å–å¾ªç¯ä¸­ï¼Œæ­£åˆ™åŒ¹é…åˆ°æŒ‡ä»¤åï¼š
    *   UI å±‚**éšè—**è¯¥æŒ‡ä»¤ï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰ã€‚
    *   ä»£ç å±‚**æ‰§è¡Œ**å¯¹åº”é€»è¾‘ã€‚

### 4.4 è”ç½‘æœç´¢æµç¨‹ (Search Flow) - V5.1 æ–°å¢
1.  **è§¦å‘æ–¹å¼**ï¼š
    *   ç”¨æˆ·è¾“å…¥ `/search å…³é”®è¯`
    *   AI è¾“å‡º `{{SEARCH: å…³é”®è¯}}`ï¼ˆéœ€åœ¨è§’è‰²è®¾ç½®ä¸­é…ç½®æœç´¢æœåŠ¡ï¼‰
2.  **æ‰§è¡Œ**: è°ƒç”¨ `searchService.performSearch`ï¼Œæ”¯æŒ Serper/Tavily/Brave/Metasoã€‚
3.  **ç»“æœæ³¨å…¥**: æœç´¢ç»“æœä½œä¸ºç³»ç»Ÿæ¶ˆæ¯æ’å…¥èŠå¤©ï¼Œå¹¶å†æ¬¡è§¦å‘ AI å›å¤ã€‚
4.  **é˜²å¾ªç¯**: ç¬¬äºŒæ¬¡è§¦å‘æ—¶ `disableSearch=true`ï¼ŒAI ä¸ä¼šå†çœ‹åˆ°æœç´¢å·¥å…·æç¤ºã€‚

### 4.5 è®°å¿†ä¸æ€»ç»“ç³»ç»Ÿ (Memory System)
1.  **è§¦å‘å™¨**: `App.tsx` ç›‘å¬ `messages.length`ã€‚å½“ `count % threshold === 0` æ—¶è§¦å‘ã€‚
2.  **æ‰§è¡Œ**: è°ƒç”¨ `summaryService.updateSessionSummary`ã€‚
3.  **åˆæˆ**: `Prompt = Old Summary + Admin Notes + Recent Messages`ã€‚
4.  **æ›´æ–°**: ç”Ÿæˆæ–°çš„ Summaryï¼Œå­˜å…¥ DBï¼Œæ¸…ç©º Admin Notesã€‚
5.  **é—­ç¯**: æ–°çš„ Summary ä¼šåœ¨ä¸‹ä¸€æ¬¡ API è°ƒç”¨æ—¶ä½œä¸º System Prompt æ³¨å…¥ï¼Œå®ç°è®°å¿†é—­ç¯ã€‚

### 4.6 ç¾¤ç»„å±‚çº§ç»“æ„ (Group Hierarchy) - V5.1 æ–°å¢
```
ç¾¤ç»„ (Group)           â†’ å…±äº«ï¼šæˆå‘˜ã€åœºæ™¯ã€è®°å¿†é…ç½®
â”œâ”€â”€ å¯¹è¯ 1 (Session)   â†’ ç‹¬ç«‹ï¼šæ¶ˆæ¯ã€æ‘˜è¦ã€ä¾¿ç­¾ã€ç¦è¨€
â”œâ”€â”€ å¯¹è¯ 2 (Session)
â””â”€â”€ å¯¹è¯ 3 (Session)
```
*   **UI**: å·¦ä¾§è¾¹æ æ˜¾ç¤ºä¸¤çº§æŠ˜å åˆ—è¡¨ã€‚
*   **æˆå‘˜ç®¡ç†**: å³ä¾§è¾¹æ æ“ä½œçš„æ˜¯ç¾¤ç»„çš„ `memberIds`ï¼Œå¯¹è¯¥ç¾¤ç»„ä¸‹æ‰€æœ‰å¯¹è¯ç”Ÿæ•ˆã€‚
*   **æ•°æ®è¿ç§»**: Dexie v2 è‡ªåŠ¨ä¸ºæ—§ Session åˆ›å»ºåŒå Groupã€‚

### 4.7 å›¾ç‰‡å‹ç¼© (Image Compression) - V5.1 æ–°å¢
Anthropic API é™åˆ¶å›¾ç‰‡ 5MBï¼Œå› æ­¤åœ¨ä¸Šä¼ æ—¶è‡ªåŠ¨å‹ç¼©ï¼š
1.  **æ£€æµ‹**: `fileParser.ts` è®¡ç®— Base64 å¤§å°ã€‚
2.  **å‹ç¼©**: ä½¿ç”¨ Canvas é™ä½è´¨é‡ (0.9â†’0.3) å’Œå°ºå¯¸ (1.0â†’0.25)ï¼Œè¾“å‡º JPEGã€‚
3.  **é…ç½®**: ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­å…³é—­æˆ–è°ƒæ•´é˜ˆå€¼ (é»˜è®¤ 4MB)ã€‚

### 4.8 å¨±ä¹å·¥å…·ç³»ç»Ÿ (Entertainment Tools) - V5.3 æ–°å¢
ä¸º TRPGã€å‰§æœ¬æ€ç­‰è§’è‰²æ‰®æ¼”åœºæ™¯æä¾›éª°å­å’Œå¡”ç½—ç‰ŒåŠŸèƒ½ã€‚

**éª°å­ç³»ç»Ÿ (Dice Rolling)ï¼š**
*   **è¯­æ³•**: `{{ROLL: XdY+Z}}` - X ä¸ª Y é¢éª°å­ + ä¿®æ­£å€¼ Z
*   **ç¤ºä¾‹**: `{{ROLL: 2d6+3}}` â†’ `2d6+3 = 11 (4+5+2)`
*   **å®ç°**: `entertainmentService.rollDice()` è§£æè¡¨è¾¾å¼å¹¶è¿”å›æ˜ç»†

**å¡”ç½—ç‰Œç³»ç»Ÿ (Tarot Cards)ï¼š**
*   **è¯­æ³•**: `{{TAROT: N}}` - æŠ½å– N å¼ ç‰Œ
*   **ç‰Œåº“**: 22 å¼ å¤§é˜¿å¡çº³ç‰Œ (Major Arcana)
*   **æ­£é€†ä½**: æ¯å¼ ç‰Œ 50% æ¦‚ç‡é€†ä½ï¼Œæ˜¾ç¤ºä¸º "ğŸ”® The Fool (Reversed)"
*   **ä¸‰ç‰Œé˜µ**: å½“ N=3 æ—¶ï¼Œè‡ªåŠ¨æ ‡æ³¨ Past / Present / Future

**é…ç½®ä¸æç¤ºè¯æ³¨å…¥ï¼š**
*   ç¾¤ç»„è®¾ç½®ä¸­å¯å•ç‹¬å¼€å…³éª°å­/å¡”ç½—åŠŸèƒ½
*   å½“åŠŸèƒ½å¼€å¯æ—¶ï¼Œè‡ªåŠ¨åœ¨ System Prompt ä¸­æ³¨å…¥ä½¿ç”¨è¯´æ˜
*   AI å®Œæˆè¾“å‡ºåï¼Œ`App.tsx` è§£ææŒ‡ä»¤å¹¶æ’å…¥ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤ºç»“æœ

### 4.9 TTS è¯­éŸ³åˆæˆç³»ç»Ÿ (Text-to-Speech) - V5.2 æ–°å¢
æ”¯æŒå¤šç§ TTS æœåŠ¡å•†ï¼Œå®ç°æ¶ˆæ¯æœ—è¯»åŠŸèƒ½ã€‚

**æ”¯æŒçš„æœåŠ¡å•†ï¼š**
| æœåŠ¡å•† | ç±»å‹ | ä»·æ ¼ (æ¯ç™¾ä¸‡å­—ç¬¦) | ç‰¹ç‚¹ |
|--------|------|------------------|------|
| Browser | æµè§ˆå™¨åŸç”Ÿ | å…è´¹ | æ— éœ€ APIï¼Œä¾èµ–ç³»ç»Ÿè¯­éŸ³ |
| OpenAI | äº‘ç«¯ | $15 | é«˜è´¨é‡ï¼Œæ”¯æŒ 6 ç§éŸ³è‰² |
| ElevenLabs | äº‘ç«¯ | $30 | æœ€è‡ªç„¶ï¼Œæ”¯æŒè‡ªå®šä¹‰éŸ³è‰²å…‹éš† |
| MiniMax | äº‘ç«¯ | $5 | æ€§ä»·æ¯”é«˜ï¼Œä¸­æ–‡ä¼˜åŒ– |
| Fish Audio | äº‘ç«¯ | $10 | å¼€æºå‹å¥½ï¼Œæ”¯æŒè‡ªè®­ç»ƒ |
| Azure | äº‘ç«¯ | $15 | ä¼ä¸šçº§ï¼Œå¤šè¯­è¨€æ”¯æŒ |

**æ’­æ”¾æ¨¡å¼ï¼š**
*   **å•æ¡æ’­æ”¾**: ç‚¹å‡»æ¶ˆæ¯æ—çš„æ’­æ”¾æŒ‰é’®ã€‚
*   **è¿ç»­æ’­æ”¾**: ä»æŸæ¡æ¶ˆæ¯å¼€å§‹ï¼Œè‡ªåŠ¨æ’­æ”¾åç»­æ‰€æœ‰æ¶ˆæ¯ã€‚
*   **è‡ªåŠ¨æ’­æ”¾**: æ–°æ¶ˆæ¯ç”Ÿæˆåè‡ªåŠ¨æœ—è¯»ã€‚

**éŸ³è‰²åˆ†é…é€»è¾‘ï¼š**
1.  ä¼˜å…ˆä½¿ç”¨ Agent é…ç½®çš„ `voiceId` + `voiceProviderId`ã€‚
2.  è‹¥æœªé…ç½®ï¼Œåˆ™ä»å½“å‰æœåŠ¡å•†çš„éŸ³è‰²åˆ—è¡¨ä¸­éšæœºåˆ†é…ã€‚
3.  ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨é»˜è®¤éŸ³è‰²ã€‚

**æ‰§è¡Œæµç¨‹ï¼š**
```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾ â†’ ttsService.speak(text, voiceId, provider)
  â†’ æ ¹æ® provider.type è·¯ç”±åˆ°å¯¹åº”å®ç°
  â†’ playOpenAITTS / playElevenLabsTTS / playMiniMaxTTS / ...
  â†’ è¿”å› { chars, cost } ç”¨äºè´¹ç”¨ç»Ÿè®¡
```

**è‡ªå®šä¹‰éŸ³è‰²ç®¡ç†ï¼š**
*   ç”¨æˆ·å¯æ‰‹åŠ¨æ·»åŠ æœåŠ¡å•†æœªè‡ªåŠ¨è·å–çš„éŸ³è‰²ï¼ˆè¾“å…¥åç§° + IDï¼‰ã€‚
*   æ”¯æŒä¸ºæ¯ä¸ª Agent å•ç‹¬æŒ‡å®šéŸ³è‰²ã€‚

---

## 5. æ‰©å±•æŒ‡å—ï¼šæ„å»ºè®°å¿†ä¸åç«¯ (Future Roadmap)

å¦‚æœæ‚¨è®¡åˆ’å¼•å…¥**å‘é‡æ•°æ®åº“ (Vector DB)** æˆ– **åç«¯æ•°æ®åº“**ï¼Œè¯·å‚è€ƒä»¥ä¸‹é‡æ„è·¯å¾„ï¼š

### é˜¶æ®µä¸€ï¼šæŠ½ç¦»çŠ¶æ€é€»è¾‘ (Refactor)
ç›®å‰ `App.tsx` æ‰¿æ‹…äº†è¿‡å¤šçš„ Controller èŒè´£ã€‚
*   **ç›®æ ‡**ï¼šå°†èŠå¤©é€»è¾‘æŠ½ç¦»ä¸º Custom Hookï¼Œä¾‹å¦‚ `useChatEngine`ã€‚
*   **å¥½å¤„**ï¼š`App.tsx` åªè´Ÿè´£å¸ƒå±€ï¼Œé€»è¾‘å±‚æ›´æ¸…æ™°ï¼Œæ–¹ä¾¿æ¥å…¥ä¸åŒçš„æ•°æ®æºã€‚

### é˜¶æ®µäºŒï¼šå¼•å…¥å‘é‡æ•°æ®åº“ (RAG Integration)
ç›®å‰çš„ä¸Šä¸‹æ–‡æ˜¯åŸºäº**æ»‘åŠ¨çª—å£ (Sliding Window)**ã€‚è¦è®© AI è®°ä½ 1000 æ¡ä¹‹å‰çš„ç»†èŠ‚ï¼š
1.  **ä¿®æ”¹ç‚¹**ï¼š`services/*Service.ts`ã€‚
2.  **åŠ¨ä½œ**ï¼š
    *   åœ¨æ„å»º `formattedMessages` ä¹‹å‰ï¼Œæˆªå–ç”¨æˆ·çš„ Queryã€‚
    *   å°† Query å‘é€åˆ°å‘é‡æ•°æ®åº“ (å¦‚ Pinecone, æˆ–æµè§ˆå™¨æœ¬åœ°çš„ Transformers.js + Voy)ã€‚
    *   æ£€ç´¢ç›¸å…³å†å²è®°å½• (Relevant Memories)ã€‚
    *   å°†æ£€ç´¢åˆ°çš„è®°å½•æ’å…¥åˆ° System Prompt çš„ `[Relevant History]` åŒºå—ä¸­ã€‚

### é˜¶æ®µä¸‰ï¼šä» IndexedDB è¿ç§»åˆ° PostgreSQL/Supabase
å¦‚æœè¦æŠŠè¿™æ˜¯ä¸€ä¸ªå•æœºåº”ç”¨å˜æˆå¤šäººåœ¨çº¿åº”ç”¨ï¼š
1.  **æ›¿æ¢ `services/db.ts`**ï¼š
    *   ä¿æŒæ–¹æ³•åä¸å˜ (`loadAllData`, `saveCollection`)ã€‚
    *   å°†å†…éƒ¨å®ç°ä» `dexie` æ›¿æ¢ä¸º `fetch('/api/...')` æˆ– `supabase-js` å®¢æˆ·ç«¯ã€‚

---

## 6. è°ƒè¯•ä¸æ„å»º

*   **æœ¬åœ°è¿è¡Œ**: `npm run dev`
*   **æ„å»ºç”Ÿäº§åŒ…**: `npm run build`
